<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="finance/layout (type=${action})">
    <div class="container-fluid" th:fragment="content">
        <div class="row page-titles">
            <div class="col-md-3 col-8 align-self-center">
                <h3 class="text-themecolor m-b-0 m-t-0">FTP</h3>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/finance/index}">Home</a></li>
                    <li class="breadcrumb-item active">FTP</li>
                </ol>
            </div>
            <div class="col-md-3 col-8 align-self-center">
                <ol class="breadcrumb ftp-menu">
                </ol>
            </div>
            <div class="col-md-6 col-4 align-self-center">
                <a th:href="@{/finance/index}" class="btn pull-right hidden-sm-down btn-success">刷新</a>
            </div>
        </div>
        <div class="row">
            <div class="col-3" style="max-height: 650px;overflow-y: auto">
                <div class="card">
                    <div class="card-block">
                        <form id="fileForm" class="form-horizontal form-material" enctype="multipart/form-data" method="POST">
                            <div class="form-group">
                                <label class="col-md-12">文件选择</label>
                                <div class="col-md-12">
                                    <input type="text" disabled class="form-control form-control-line fileName"/>
                                    <input type="file" id="file" name="file" style="position: absolute;top:0;left: 0;opacity: 0;width: 100%;height: 100%"/>
                                    <script>
                                        $("#file").on('change', function( e ){
                                            var name = e.currentTarget.files[0].name;
                                            $(".fileName").val(name);
                                         });
                                    </script>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-12">保存名</label>
                                <div class="col-md-12">
                                    <input type="text" name="fileName" class="form-control form-control-line fileName">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-12">文件夹</label>
                                <div class="col-md-12">
                                    <input name="folder" class="form-control form-control-line"/>
                                </div>
                            </div>
                        </form>
                        <div class="form-group">
                            <div class="col-sm-12">
                                <button class="btn btn-success" id="submnitBtn" onclick="uploadFile()">上传</button>
                                <script>
                                    function uploadFile() {
                                        var formData = new FormData();
                                        formData.append("file",$("#file")[0].files[0]);
                                        formData.append("folder",$("input[name='folder']").val());
                                        formData.append("fileName",$("input[name='fileName']").val());
                                        $.ajax({
                                            url : _ctx+"uploadFile",
                                            type : 'POST',
                                            data : formData,
                                            processData : false,
                                            contentType : false,
                                            beforeSend:function(){
                                                $("#submnitBtn").attr("disabled",true);
                                            },
                                            success:function (data) {
                                                if(data.code==200){
                                                    alert("上传成功");
                                                    fullFiles("big");
                                                }else{
                                                    alert("上传失败")
                                                }
                                            },
                                            error:function () {
                                                alert("上传失败");
                                            },
                                            complete:function () {
                                                $("#submnitBtn").attr("disabled",false);
                                            }
                                        });
                                    }
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-9" style="min-height: 650px;overflow-y: auto">
                <table class="table stylish-table">
                    <tr>
                        <th style="width:100px;">标识</th>
                        <th>类型</th>
                        <th>名称</th>
                        <th>大小</th>
                        <th>操作</th>
                    </tr>
                    <tbody class="fileList">
                    </tbody>
                    <script>
                        $(function () {
                            fullFiles("big");
                        })
                        //填充文件显示区
                        function fullFiles(dir) {
                            var menu = "",url = "";
                            var split = dir.split("/");
                            for(var i=0;i<split.length;i++){
                                if(split[i]) {
                                    url += split[i] + "/";
                                    menu += "<li class='breadcrumb-item active'><a href='javascript:;' onclick='fullFiles(\"" + url + "\")'>" + split[i] + "</a></li>";
                                }
                            }
                            $(".breadcrumb.ftp-menu").html(menu);
                            $.post(_ctx+"finance/getFTPFiles",{dir:dir},function (data) {
                                if(data.code!=200){
                                    alert("获取文件列表失败");
                                }else{
                                    var files = data.data;
                                    var str = "";
                                    if(files.length>0){
                                        for (let file of files){
                                            if(file.type=='目录')
                                                str += "<tr onclick='fullFiles(\""+dir+"/"+file.name+"\")' style='cursor: pointer'>";
                                            else
                                                str += "<tr>";
                                            str += "     <td>";
                                            str += "        <span class='fa "+file.icon+"'></span>";
                                            str += "     </td>";
                                            str += "     <td>"+file.type+"</td>";
                                            str += "     <td>"+file.name+"</td>";
                                            str += "     <td>"+(file.size/1024/1024).toFixed(2)+"MB</td>";
                                            str += "     <td><button class='btn hidden-sm-down btn-danger btn-sm fa fa-trash-o'>&nbsp;删除</button></td>";
                                            str += "</tr>";
                                        }
                                    }else {
                                        str = "<tr><td colspan='6'></td>无数据</td></tr>";
                                    }
                                    $("tbody.fileList").html(str);
                                }
                            })
                        }
                    </script>
                </table>
            </div>
        </div>
    </div>
</html>
